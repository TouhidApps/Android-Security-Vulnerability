package com.touhidapps.securedsharedpreferences

import android.content.SharedPreferences
import android.graphics.Color
import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import androidx.security.crypto.EncryptedSharedPreferences
import androidx.security.crypto.MasterKeys
import kotlinx.android.synthetic.main.activity_main.*

class MainActivity : AppCompatActivity() {

    private val masterKeyAlias = MasterKeys.getOrCreate(MasterKeys.AES256_GCM_SPEC)

    private lateinit var sharedPreferences: SharedPreferences

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        /**
         * To make secure application
         * Use EncryptedSharedPreferences to save user name, user id, password etc.
         */


        sharedPreferences = EncryptedSharedPreferences.create(
            "secret_shared_prefs",
            masterKeyAlias,
            this,
            EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
            EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
        )

        /**
         * Save text after clicking save button
         */
        buttonSave.setOnClickListener {

            val editor: SharedPreferences.Editor = sharedPreferences.edit()
            editor.putString("KEY_NAME", editTextInput.text.toString())
            editor.commit()

        }

        /**
         * get text from preferences
         */
        buttonGet.setOnClickListener {

            try {

                val res = sharedPreferences.getString("KEY_NAME", "")
                res.let {
                    textViewResult.text = it
                }

            } catch (ie: IllegalArgumentException) {
                // TODO Show message to user to clear app data & go to login page

                textViewResult.setTextColor(Color.RED)
                textViewResult.text = "Please Clear app data and try again! (Illigal)"

            } catch ( se: SecurityException){

                textViewResult.setTextColor(Color.RED)
                textViewResult.text = "Please Clear app data and try again! (Security)"

            }


        }





    } // onCreate


}
